name: Build 3rdlibs

# on:
#   push:
#     branches: [main]
#     paths:
#       - scripts/**
on:
  release:
    types: [prereleased]
  # pull_request:
  #   branches: [master]
  #   paths:
  #     - scripts/**


env:
  BUILD_TYPE: Release

jobs:
  build-3rdlibs:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            python: "3.10"
          - os: ubuntu-24.04
            python: "3.12"

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{matrix.python}}
        
    - name: Install3rd base
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y \
        build-essential cmake zlib1g-dev \
        freeglut3-dev libbz2-dev libglib2.0 \
        python3-dev python3-pip python3-tk  \
        qtbase5-dev qt5-qmake libqt5svg5-dev \
        libqt5webkit5-dev libqt5designer5
        python3 -m pip install numpy matplotlib xlib ipython
        pip install --upgrade setuptools
        
    - name: 1 create the 3rdlib dir
      shell: bash
      working-directory: ${{github.workspace}}
      run: |
        mkdir 3rdlib
        cd 3rdlib
        mkdir -p 3rdlibs/py
        mkdir HeaderLib    

    - name: 2 install bzip2
      shell: bash
      working-directory: ${{github.workspace}}/3rdlib
      run: |
        #wget https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz
        wget https://github.com/SwaySZ/thirdsource/releases/latest/download/bzip2-1.0.8.tar.gz
        tar xzf bzip2-1.0.8.tar.gz
        cd bzip2-1.0.8
        make
        make install PREFIX=${{github.workspace}}/3rdlib/HeaderLib

    - name: 3 Boost install
      shell: bash
      working-directory: ${{github.workspace}}/3rdlib
      run: |
        wget https://archives.boost.io/release/1.90.0/source/boost_1_90_0.tar.gz
        tar xzf boost_1_90_0.tar.gz
        cd boost_1_90_0
        ./bootstrap.sh  --with-libraries=python,thread,filesystem,iostreams,regex,serialization,system,date_time link=shared runtime-link=shared --without-icu --with-python=python3
        ./b2 #âˆ’j4 #compile with 3 threads
        ./b2 install --prefix=${{github.workspace}}/3rdlib/HeaderLib

    - name: 4 Eigen and minieigen
      shell: bash
      working-directory: ${{github.workspace}}/3rdlib
      run: |
        #wget https://gitlab.com/libeigen/eigen/-/archive/3.3.5/eigen-3.3.5.tar.gz
        wget https://github.com/SwaySZ/thirdsource/releases/latest/download/eigen-3.3.5.tar.gz
        tar xzf eigen-3.3.5.tar.gz
        mv eigen-3.3.5 Eigen-3.3.5
        cp -rf Eigen-3.3.5 ./HeaderLib/
        wget https://github.com/SwaySZ/minieigen/archive/refs/tags/v2026.1.11.tar.gz
        tar xzf v2026.1.11.tar.gz
        cd minieigen-2026.1.11
        mkdir build
        cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/3rdlib/HeaderLib/lib/py
        make #-j4
        make install

    - name: 5 LibQGLViewer-2.6.3
      shell: bash
      working-directory: ${{github.workspace}}/3rdlib
      run: |
        wget https://github.com/SwaySZ/libQGLViewer-2.6.3/archive/refs/tags/2.6.3.tar.gz
        tar xzf 2.6.3.tar.gz
        cd libQGLViewer-2.6.3-2.6.3/QGLViewer
        qmake
        make
        make install

    - name: 6 Sip and PyQt5
      shell: bash
      working-directory: ${{github.workspace}}/3rdlib
      run: |
        # 1. Install modern build tools required for PyQt5 5.15+
        python3 -m pip install --upgrade pip
        python3 -m pip install "sip>=6.0" "PyQt-builder>=1.10" "PyQt5-sip"
        
        #wget https://github.com/SwaySZ/thirdsource/releases/latest/download/sip-6.15.1.tar.gz
        #tar xzf sip-6.15.1.tar.gz
        #cd ${{github.workspace}}/3rdlib/sip-6.15.1
        ## Modern SIP 6 build and installation to your custom path
        #python3 -m pip install . --target=${{github.workspace}}/HeaderLib/lib/py
        ## Ensure the 'sip' executable is available for PyQt5
        #echo "${{github.workspace}}/HeaderLib/lib/py/bin" >> $GITHUB_PATH
        ## PYQT5
        cd ${{github.workspace}}/3rdlib
        wget https://github.com/SwaySZ/thirdsource/releases/latest/download/PyQt5-5.15.11.tar.gz
        tar xzf PyQt5-5.15.11.tar.gz
        cd PyQt5-5.15.11
        # Use the modern SIP-based installer for PyQt5
        sip-install \
          --confirm-license \
          --qmake /usr/bin/qmake \
          --target-dir ${{github.workspace}}/HeaderLib/lib/py \
          --bin-dir ${{github.workspace}}/SudoDEMTools/PyQt5/bin \
          --designer-plugindir ${{github.workspace}}/SudoDEMTools/PyQt5/plugin \
          --qml-plugindir ${{github.workspace}}/SudoDEMTools/PyQt5/qml \
          --stubs-dir ${{github.workspace}}/SudoDEMTools/PyQt5/stubs \
          --no-tools


    - name: Archive Release
      working-directory: ${{github.workspace}}/
      run: |
          tar cfJ 3rdlibs-${{matrix.os}}.tar.xz ${{github.workspace}}/3rdlib/HeaderLib
          tar cfJ tools-${{matrix.os}}.tar.xz SudoDEMTools

    - name: upload compiled 3rdlibs
      uses: actions/upload-artifact@v4
      with:
        name: 3rdlibs-${{matrix.os}}
        path: |
          ${{github.workspace}}/3rdlibs-${{matrix.os}}.tar.xz

    - name: upload compiled tools
      uses: actions/upload-artifact@v4
      with:
        name: tools-${{matrix.os}}
        path: |
          ${{github.workspace}}/tools-${{matrix.os}}.tar.xz

    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ${{github.workspace}}/*-${{matrix.os}}.tar.xz
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true
